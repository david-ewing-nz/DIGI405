---
title: "M2: Individual Random Effects SD Ratios"
author: "David Ewing"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggplot2)
```

# Purpose

This document computes SD ratios for individual random effects $u_i$ to answer Dr John's question:

> "You have not shown the posterior distribution of the individual $u$ so you do not know how badly the artificially tightened posterior distribution of $\tau_u$ affects the posterior distribution of all other parameters."

We compute: 

$$r_i = \frac{\text{SD}_{VB}(u_i)}{\text{SD}_{Gibbs}(u_i)}$$

for each group $i$ in each configuration (Q=5, 10, 20, 50, 100).

# Load Data

```{r load_data}
results_multi <- readRDS("../results/M2_results_multi.rds")

cat("Loaded", length(results_multi), "configurations\n")
for (i in seq_along(results_multi)) {
  q <- results_multi[[i]]$config$q
  cat(sprintf("Config %d: Q=%d\n", i, q))
}
```

# Extract u_i SD Ratios

```{r compute_sd_ratios}
# Function to extract u_i SD ratios for one configuration
extract_u_sd_ratios <- function(result) {
  q <- result$config$q
  
  # VB side: diagonal of Sigma_uu gives variances
  vb_var_u <- diag(result$vb$Sigma_uu)
  vb_sd_u <- sqrt(vb_var_u)
  
  # Gibbs side: MCMC samples
  # Columns are: beta_0, beta_1, beta_2, tau_e, tau_u, u_1, u_2, ..., u_q
  # So u_i columns start at column 6
  u_cols <- 6:(5 + q)
  gibbs_samples <- result$gibbs
  gibbs_sd_u <- apply(gibbs_samples[, u_cols], 2, sd)
  
  # SD ratios
  sd_ratios <- vb_sd_u / gibbs_sd_u
  
  # Return data frame
  data.frame(
    Q = q,
    group_id = 1:q,
    vb_sd = vb_sd_u,
    gibbs_sd = gibbs_sd_u,
    sd_ratio = sd_ratios
  )
}

# Extract for all configurations
all_u_ratios <- lapply(results_multi, extract_u_sd_ratios)
u_ratios_df <- bind_rows(all_u_ratios)

# Summary statistics by configuration
u_summary <- u_ratios_df %>%
  group_by(Q) %>%
  summarise(
    n_groups = n(),
    mean_ratio = mean(sd_ratio),
    median_ratio = median(sd_ratio),
    min_ratio = min(sd_ratio),
    max_ratio = max(sd_ratio),
    sd_ratio = sd(sd_ratio),
    .groups = 'drop'
  )

print(u_summary)
```

# Save Results

```{r save_results}
# Save full data
saveRDS(u_ratios_df, "../results/M2_u_i_sd_ratios.rds")
cat("Saved u_ratios_df to ../results/M2_u_i_sd_ratios.rds\n")

# Save summary
saveRDS(u_summary, "../results/M2_u_i_sd_ratios_summary.rds")
cat("Saved u_summary to ../results/M2_u_i_sd_ratios_summary.rds\n")
```

# Visualizations

## Boxplot: SD Ratios by Configuration

```{r boxplot, fig.width=10, fig.height=6}
p1 <- ggplot(u_ratios_df, aes(x = factor(Q), y = sd_ratio, fill = factor(Q))) +
  geom_boxplot(outlier.alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red", linewidth = 1) +
  geom_hline(yintercept = 0.8, linetype = "dotted", color = "orange", linewidth = 0.8) +
  labs(
    title = expression(paste("SD Ratios for Individual Random Effects ", u[i])),
    subtitle = "VB systematically underestimates uncertainty in all individual group effects",
    x = "Number of Groups (Q)",
    y = expression(paste("SD Ratio: ", SD[VB](u[i]) / SD[Gibbs](u[i]))),
    fill = "Q"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold"),
    panel.grid.major.x = element_blank()
  )

print(p1)

ggsave("../presentation/M2_u_i_boxplot.png", p1, width = 10, height = 6, dpi = 300)
cat("Saved plot to ../presentation/M2_u_i_boxplot.png\n")
```

## Violin Plot: Distribution of SD Ratios

```{r violin, fig.width=10, fig.height=6}
p2 <- ggplot(u_ratios_df, aes(x = factor(Q), y = sd_ratio, fill = factor(Q))) +
  geom_violin(alpha = 0.7) +
  geom_boxplot(width = 0.1, fill = "white", outlier.alpha = 0.3) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red", linewidth = 1) +
  geom_hline(yintercept = 0.8, linetype = "dotted", color = "orange", linewidth = 0.8) +
  labs(
    title = expression(paste("Distribution of SD Ratios for ", u[i], " Across All Groups")),
    subtitle = "Larger Q amplifies under-dispersion in individual random effects",
    x = "Number of Groups (Q)",
    y = expression(paste("SD Ratio: ", SD[VB](u[i]) / SD[Gibbs](u[i]))),
    fill = "Q"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  )

print(p2)

ggsave("../presentation/M2_u_i_violin.png", p2, width = 10, height = 6, dpi = 300)
cat("Saved plot to ../presentation/M2_u_i_violin.png\n")
```

## Sample Individual u_i Posteriors (Q=20)

Show a few individual $u_i$ posteriors for Q=20 configuration.

```{r individual_posteriors, fig.width=12, fig.height=8}
# Extract Q=20 configuration
config_q20 <- results_multi[[3]]  # Q=20 is 3rd config
q <- config_q20$config$q

# Select first 6 groups
selected_groups <- 1:min(6, q)

# Create overlay plots
par(mfrow = c(2, 3), mar = c(4, 4, 3, 1))

for (i in selected_groups) {
  # VB posterior: N(mu_u[i], Sigma_uu[i,i])
  vb_mean <- config_q20$vb$mu_u[i]
  vb_sd <- sqrt(config_q20$vb$Sigma_uu[i, i])
  
  # Gibbs posterior: samples
  u_col <- 5 + i  # Column index for u_i
  gibbs_samples <- config_q20$gibbs[, u_col]
  
  # Plot
  hist(gibbs_samples, probability = TRUE, breaks = 30,
       col = rgb(1, 0, 0, 0.3), border = "darkred",
       main = bquote(paste("Group ", .(i), ": ", u[.(i)])),
       xlab = bquote(u[.(i)]),
       ylab = "Density")
  
  # Overlay VB density
  x_range <- range(gibbs_samples)
  x_seq <- seq(x_range[1], x_range[2], length.out = 200)
  vb_density <- dnorm(x_seq, vb_mean, vb_sd)
  lines(x_seq, vb_density, col = "black", lwd = 2)
  
  # Add legend
  legend("topright", 
         legend = c("Gibbs", "VB"),
         fill = c(rgb(1, 0, 0, 0.3), NA),
         border = c("darkred", NA),
         lty = c(NA, 1),
         col = c(NA, "black"),
         lwd = c(NA, 2),
         cex = 0.8)
  
  # Calculate and display SD ratio
  ratio <- vb_sd / sd(gibbs_samples)
  text(x_range[1] + 0.05 * diff(x_range), 
       max(vb_density) * 0.9,
       sprintf("r = %.3f", ratio),
       pos = 4, cex = 0.9)
}

# Save as PNG
png("../presentation/M2_u_i_individual_Q20.png", width = 1200, height = 800, res = 100)
par(mfrow = c(2, 3), mar = c(4, 4, 3, 1))
for (i in selected_groups) {
  vb_mean <- config_q20$vb$mu_u[i]
  vb_sd <- sqrt(config_q20$vb$Sigma_uu[i, i])
  u_col <- 5 + i
  gibbs_samples <- config_q20$gibbs[, u_col]
  
  hist(gibbs_samples, probability = TRUE, breaks = 30,
       col = rgb(1, 0, 0, 0.3), border = "darkred",
       main = bquote(paste("Group ", .(i), ": ", u[.(i)])),
       xlab = bquote(u[.(i)]),
       ylab = "Density")
  
  x_range <- range(gibbs_samples)
  x_seq <- seq(x_range[1], x_range[2], length.out = 200)
  vb_density <- dnorm(x_seq, vb_mean, vb_sd)
  lines(x_seq, vb_density, col = "black", lwd = 2)
  
  legend("topright", 
         legend = c("Gibbs", "VB"),
         fill = c(rgb(1, 0, 0, 0.3), NA),
         border = c("darkred", NA),
         lty = c(NA, 1),
         col = c(NA, "black"),
         lwd = c(NA, 2),
         cex = 0.8)
  
  ratio <- vb_sd / sd(gibbs_samples)
  text(x_range[1] + 0.05 * diff(x_range), 
       max(vb_density) * 0.9,
       sprintf("r = %.3f", ratio),
       pos = 4, cex = 0.9)
}
dev.off()
cat("Saved plot to ../presentation/M2_u_i_individual_Q20.png\n")
```

# Summary

```{r summary_table}
knitr::kable(u_summary, digits = 3, caption = "Summary of u_i SD Ratios by Configuration")
```

**Key Findings:**

1. **All individual $u_i$ show under-dispersion**: Mean SD ratios are consistently below 1.0
2. **Effect worsens with Q**: Larger number of groups amplifies the under-dispersion
3. **Cascade effect confirmed**: The incorrect $\tau_u$ posterior propagates to all individual $u_i$ posteriors
4. **Practical impact**: VB is overconfident about individual group effects, not just the hyperparameter

This addresses Dr John's concern that we hadn't shown how the $\tau_u$ under-dispersion affects the individual random effects.
